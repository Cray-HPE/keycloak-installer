
# This file is copied from the cray-service chart

---
apiVersion: cert-manager.io/v1alpha2
kind: Certificate
metadata:
  name: "keycloak-postgres-tls"
spec:
  secretName: "keycloak-postgres-tls"
  duration: 720h
  renewBefore: 24h
  organization:
    - Cray
  commonName: "keycloak-postgres.{{ .Release.Namespace }}.cluster.svc"
  isCA: false
  keySize: 2048
  keyAlgorithm: rsa
  keyEncoding: pkcs1
  usages:
    - server auth
    - client auth
  dnsNames:
    - "keycloak-postgres.{{ .Release.Namespace }}.cluster.svc"
    - "keycloak-postgres.{{ .Release.Namespace }}"
    - "*.keycloak-postgres.{{ .Release.Namespace }}"
  issuerRef:
    name: cert-manager-issuer-common
    kind: Issuer
---
apiVersion: "acid.zalan.do/v1"
kind: postgresql
metadata:
  name: "keycloak-postgres"
  labels:
    app.kubernetes.io/name: keycloak-postgres
spec:
  teamId: "keycloak"
  volume:
    size: 10Gi
  numberOfInstances: 3
  podPriorityClassName: csm-high-priority-service
  users:
    service_account: []
  databases:
    service_db: service_account
  postgresql:
    version: "11"
  tls:
    secretName: "keycloak-postgres-tls"

---
kind: Service
apiVersion: v1
metadata:
  name: "keycloak-postgres-0"
  labels:
    cluster-name: keycloak-postgres
    role: pod
spec:
  selector:
    statefulset.kubernetes.io/pod-name: "keycloak-postgres-0"
  ports:
    - protocol: TCP
      port: 5432
      targetPort: 5432

---
kind: Service
apiVersion: v1
metadata:
  name: "keycloak-postgres-1"
  labels:
    cluster-name: keycloak-postgres
    role: pod
spec:
  selector:
    statefulset.kubernetes.io/pod-name: "keycloak-postgres-1"
  ports:
    - protocol: TCP
      port: 5432
      targetPort: 5432

---
kind: Service
apiVersion: v1
metadata:
  name: "keycloak-postgres-2"
  labels:
    cluster-name: keycloak-postgres
    role: pod
spec:
  selector:
    statefulset.kubernetes.io/pod-name: "keycloak-postgres-2"
  ports:
    - protocol: TCP
      port: 5432
      targetPort: 5432

---
apiVersion: "security.istio.io/v1beta1"
kind: "PeerAuthentication"
metadata:
  name: "keycloak-postgres"
spec:
  selector:
    matchLabels:
      cluster-name: keycloak-postgres
  portLevelMtls:
    5432:
      mode: PERMISSIVE

---
apiVersion: batch/v1
kind: Job
metadata:
  name: "keycloak-wait-for-postgres-{{ .Release.Revision }}"
  labels:
    app.kubernetes.io/name: keycloak-wait-for-postgres
spec:
  template:
    spec:
      restartPolicy: Never
      containers:
        - name: "postgres-watcher-service-db"
          image: "{{ .Values.imagesHost }}/cache/postgres:13.2"
          securityContext:
            runAsUser: 65534
            runAsGroup: 65534
            runAsNonRoot: true
          command: ["sh", "-c", "until psql postgres://$POSTGRES_USER:$POSTGRES_PASSWORD@$POSTGRES_HOST:$POSTGRES_PORT/$POSTGRES_DB -c 'select version();'; do echo waiting for postgres db $POSTGRES_DB; sleep 2; done;  echo 'POSTGRES_READY';"]
          env:
          - name: POSTGRES_USER
            valueFrom:
              secretKeyRef:
                name: service-account.keycloak-postgres.credentials
                key: username
          - name: POSTGRES_PASSWORD
            valueFrom:
              secretKeyRef:
                name: service-account.keycloak-postgres.credentials
                key: password
          - name: POSTGRES_HOST
            value: "keycloak-postgres"
          - name: POSTGRES_PORT
            value: "5432"
          - name: POSTGRES_DB
            value: "service_db"
          resources:
            requests:
              cpu: 100m
              memory: "10Mi"
            limits:
              cpu: 500m
              memory: "1Gi"
